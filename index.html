<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biovetfarma — MVP Prescrição Digital Veterinária</title>
  <style>
    :root {
      color-scheme: light dark;
      --primary: #2E7D32;
      --primary-dark: #1b5e20;
      --secondary: #263238;
      --bg: #f4f7f9;
      --surface: #ffffff;
      --muted: #60707b;
      --border: rgba(38, 50, 56, 0.1);
      --shadow: 0 18px 48px rgba(38, 50, 56, 0.12);
      --radius: 16px;
      --text: #263238;
      --text-contrast: #ffffff;
      --surface-elevated: #ffffff;
      --input-bg: #ffffff;
      --badge-bg: rgba(46, 125, 50, 0.14);
      --badge-text: #1b5e20;
    }

    body.theme-dark {
      --bg: #111b22;
      --surface: #16232b;
      --surface-elevated: #1d2d38;
      --text: #f4f7f9;
      --muted: #9aacb8;
      --border: rgba(148, 164, 175, 0.18);
      --shadow: 0 22px 46px rgba(0, 0, 0, 0.45);
      --input-bg: #132028;
      --badge-bg: rgba(76, 175, 80, 0.24);
      --badge-text: #c5f7c8;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px 12px 48px;
    }

    h1, h2, h3, h4 { margin: 0; font-weight: 700; }
    p { margin: 0; }
    ul { margin: 0; padding-left: 18px; }
    button { font: inherit; }

    .hidden { display: none !important; }

    .app-shell {
      width: 100%;
      max-width: 1100px;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px;
      border: 1px solid var(--border);
    }

    .auth-card {
      max-width: 420px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
      text-align: left;
    }

    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      color: var(--primary);
    }

    .brand-logo {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(46, 125, 50, 0.18), rgba(46, 125, 50, 0.5));
    }

    .tabs-toggle {
      display: flex;
      background: rgba(38, 50, 56, 0.04);
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
    }

    .tabs-toggle button {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      background: transparent;
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .tabs-toggle button.active {
      background: var(--primary);
      color: #ffffff;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    label {
      font-size: 14px;
      font-weight: 600;
      color: var(--secondary);
    }

    body.theme-dark label { color: #cfd8dc; }

    input, select, textarea {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: inherit;
      font-size: 15px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    textarea { resize: vertical; min-height: 120px; }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: rgba(46, 125, 50, 0.6);
      box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.18);
    }

    .btn {
      border: none;
      border-radius: 12px;
      padding: 13px 18px;
      font-weight: 600;
      background: var(--primary);
      color: var(--text-contrast);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.12s ease, filter 0.2s ease;
    }

    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }

    .btn-outline {
      background: transparent;
      border: 1px solid rgba(46, 125, 50, 0.3);
      color: var(--primary);
    }

    .btn-ghost {
      background: rgba(46, 125, 50, 0.12);
      color: var(--primary);
    }

    .app-header {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }

    .header-top {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: stretch;
    }

    .header-row {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (min-width: 720px) {
      .header-top { flex-direction: row; justify-content: space-between; align-items: center; }
      .header-row { flex-direction: row; align-items: center; }
      .header-row > * { flex: 1; }
      .header-actions { justify-content: flex-end; }
    }

    .header-info {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: var(--shadow);
    }

    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .header-search {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .tablist {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 24px;
    }

    @media (min-width: 720px) {
      .tablist { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }

    .tab-btn {
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow);
      color: inherit;
      font-weight: 600;
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.12s ease;
    }

    .tab-btn[aria-selected="true"] {
      border-color: rgba(46, 125, 50, 0.6);
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .library-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 18px;
    }

    @media (min-width: 620px) {
      .library-controls { flex-direction: row; }
      .library-controls > * { flex: 1; }
      .library-controls select { max-width: 220px; }
    }

    .library-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .library-list { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .library-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--badge-bg);
      color: var(--badge-text);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .pill-list { display: flex; flex-wrap: wrap; gap: 6px; }
    .pill-list span { background: rgba(38, 50, 56, 0.08); padding: 4px 8px; border-radius: 999px; font-size: 12px; }
    body.theme-dark .pill-list span { background: rgba(148, 164, 175, 0.22); }

    .prescription-grid {
      display: grid;
      gap: 18px;
    }

    @media (min-width: 880px) {
      .prescription-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .prescription-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px;
      box-shadow: var(--shadow);
    }

    .dose-box {
      padding: 14px 16px;
      border-radius: 14px;
      background: rgba(46, 125, 50, 0.08);
      border: 1px dashed rgba(46, 125, 50, 0.36);
      font-size: 14px;
      line-height: 1.4;
    }

    .range-wrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .range-wrapper input[type="range"] {
      width: 100%;
    }

    .range-wrapper.no-range input[type="range"] {
      display: none;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--surface);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .history-table th, .history-table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      text-align: left;
    }

    .history-table tbody tr:hover {
      background: rgba(46, 125, 50, 0.08);
    }

    .empty-state {
      padding: 22px;
      border-radius: var(--radius);
      border: 1px dashed var(--border);
      text-align: center;
      color: var(--muted);
      background: var(--surface);
    }

    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 16px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      padding: 14px 18px;
      border-radius: 12px;
      background: var(--surface-elevated);
      border: 1px solid rgba(46, 125, 50, 0.28);
      box-shadow: var(--shadow);
      font-size: 14px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .toast.error { border-color: rgba(198, 40, 40, 0.45); color: #d32f2f; }
    .toast.success { border-color: rgba(46, 125, 50, 0.45); color: #1b5e20; }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 30, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 90;
    }

    .modal.open { display: flex; }

    .modal-card {
      max-width: 680px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      border-radius: 20px;
      background: var(--surface);
      box-shadow: 0 30px 80px rgba(15, 23, 30, 0.35);
      display: flex;
      flex-direction: column;
    }

    .modal-header, .modal-footer {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }

    .modal-footer { border-top: 1px solid var(--border); border-bottom: none; justify-content: flex-end; flex-wrap: wrap; }

    .modal-body {
      padding: 22px 24px;
      overflow-y: auto;
    }

    .preview-receita {
      background: rgba(38, 50, 56, 0.04);
      border-radius: var(--radius);
      padding: 18px;
      display: grid;
      gap: 12px;
    }

    .preview-table {
      width: 100%;
      border-collapse: collapse;
    }

    .preview-table th, .preview-table td {
      border-bottom: 1px solid var(--border);
      padding: 10px 8px;
      text-align: left;
      font-size: 14px;
    }

    .switch {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
      user-select: none;
    }

    .switch input { display: none; }

    .switch-slider {
      width: 44px;
      height: 24px;
      background: rgba(38, 50, 56, 0.25);
      border-radius: 999px;
      position: relative;
      transition: background 0.2s ease;
    }

    .switch-slider::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 4px;
      width: 18px;
      height: 18px;
      background: #ffffff;
      border-radius: 50%;
      transition: transform 0.2s ease;
    }

    .switch input:checked + .switch-slider {
      background: var(--primary);
    }

    .switch input:checked + .switch-slider::after {
      transform: translateX(18px);
    }

    .config-card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 20px;
      box-shadow: var(--shadow);
      display: grid;
      gap: 16px;
    }

    .muted { color: var(--muted); font-size: 14px; }

    .actions-row { display: flex; gap: 10px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>
  <div class="app-shell">
    <section id="authView" class="card auth-card" aria-label="Autenticação">
      <div class="brand">
        <span class="brand-logo" aria-hidden="true"></span>
        <div>
          <h1>Biovetfarma — MVP Prescrição</h1>
          <p class="muted">Acesse com seu CRMV para gerenciar prescrições digitais.</p>
        </div>
      </div>
      <div class="tabs-toggle" role="tablist" aria-label="Selecione o tipo de acesso">
        <button id="authLoginTab" class="active" role="tab" aria-selected="true" aria-controls="loginPanel">Entrar</button>
        <button id="authRegisterTab" role="tab" aria-selected="false" aria-controls="registerPanel">Criar conta</button>
      </div>
      <form id="loginForm" aria-labelledby="authLoginTab" role="tabpanel" tabindex="0">
        <div>
          <label for="loginEmail">E-mail</label>
          <input id="loginEmail" name="email" type="email" autocomplete="username" required />
        </div>
        <div>
          <label for="loginSenha">Senha</label>
          <input id="loginSenha" name="senha" type="password" autocomplete="current-password" minlength="6" required />
        </div>
        <button class="btn" type="submit">Entrar</button>
      </form>
      <form id="registerForm" class="hidden" aria-labelledby="authRegisterTab" role="tabpanel" tabindex="0">
        <div>
          <label for="registerNome">Nome completo</label>
          <input id="registerNome" name="nome" type="text" autocomplete="name" required />
        </div>
        <div>
          <label for="registerEmail">E-mail</label>
          <input id="registerEmail" name="email" type="email" autocomplete="email" required />
        </div>
        <div>
          <label for="registerCrmv">CRMV</label>
          <input id="registerCrmv" name="crmv" type="text" autocomplete="off" required />
        </div>
        <div>
          <label for="registerSenha">Senha (mínimo 6 caracteres)</label>
          <input id="registerSenha" name="senha" type="password" autocomplete="new-password" minlength="6" required />
        </div>
        <button class="btn" type="submit">Criar conta</button>
      </form>
    </section>

    <div id="appView" class="hidden" aria-live="polite">
      <header class="app-header">
        <div class="header-top">
          <div class="header-info" aria-live="polite">
            <h2>Biovetfarma — MVP Prescrição</h2>
            <p id="headerUser" class="muted"></p>
          </div>
          <div class="header-actions">
            <div class="header-search">
              <input id="globalSearch" type="search" placeholder="Busca global por ativos ou indicações" aria-label="Busca global" />
              <button id="globalSearchBtn" class="btn-outline btn" type="button">Buscar</button>
            </div>
            <button id="newPrescriptionBtn" class="btn" type="button">Novo</button>
            <button id="logoutBtn" class="btn-outline btn" type="button">Sair</button>
            <label class="switch" for="themeToggle">
              <input id="themeToggle" type="checkbox" />
              <span class="switch-slider" aria-hidden="true"></span>
              <span>Modo escuro</span>
            </label>
          </div>
        </div>
        <nav class="tablist" role="tablist" aria-label="Sessões do dashboard">
          <button class="tab-btn" role="tab" aria-selected="true" aria-controls="tab-prescrever" id="tabBtnPrescrever">Prescrever</button>
          <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-biblioteca" id="tabBtnBiblioteca">Biblioteca de Ativos</button>
          <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-historico" id="tabBtnHistorico">Pacientes & Histórico</button>
          <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-config" id="tabBtnConfig">Configurações</button>
        </nav>
      </header>

      <main>
        <section id="tab-prescrever" class="tab-panel active" role="tabpanel" aria-labelledby="tabBtnPrescrever">
          <div class="prescription-grid">
            <article class="prescription-card">
              <h3>Dados do paciente</h3>
              <form id="prescriptionForm">
                <div>
                  <label for="tutorNome">Tutor</label>
                  <input id="tutorNome" name="tutor" type="text" placeholder="Nome do responsável (opcional)" />
                </div>
                <div>
                  <label for="pacienteNome">Paciente</label>
                  <input id="pacienteNome" name="paciente" type="text" placeholder="Paciente (caso diferente do nome do animal)" />
                </div>
                <div>
                  <label for="animalNome">Animal</label>
                  <input id="animalNome" name="animal" type="text" required />
                </div>
                <div>
                  <label for="especie">Espécie</label>
                  <select id="especie" name="especie" required>
                    <option value="">Selecione</option>
                    <option value="Cão">Cão</option>
                    <option value="Gato">Gato</option>
                  </select>
                </div>
                <div>
                  <label for="peso">Peso (kg)</label>
                  <input id="peso" name="peso" type="number" min="0" step="0.1" required />
                </div>
                <div>
                  <label for="idade">Idade (opcional)</label>
                  <input id="idade" name="idade" type="text" placeholder="Ex.: 5 anos" />
                </div>
                <div>
                  <label for="diagnostico">Diagnóstico</label>
                  <input id="diagnostico" name="diagnostico" type="text" placeholder="Ex.: Insuficiência hepática" />
                </div>
                <div>
                  <label for="ativoNome">Ativo</label>
                  <input id="ativoNome" name="ativo" type="text" list="ativosDatalist" autocomplete="off" required />
                  <datalist id="ativosDatalist"></datalist>
                </div>
                <div>
                  <label for="forma">Concentração / Forma farmacêutica</label>
                  <input id="forma" name="forma" type="text" placeholder="Ex.: Cápsula 50 mg" />
                </div>
                <div>
                  <label for="doseMgKg">Posologia (mg/kg)</label>
                  <div class="range-wrapper no-range" id="doseRangeWrapper">
                    <input id="doseRange" type="range" min="1" max="10" step="0.1" aria-label="Selecionar mg por kg" />
                    <div class="actions-row">
                      <input id="doseMgKg" type="number" step="0.1" min="0" required />
                      <span class="muted" id="doseHint">Selecione um ativo para sugestões de dose.</span>
                    </div>
                  </div>
                </div>
                <div class="dose-box" id="doseResumo">Informe peso e mg/kg para calcular a dose.</div>
                <div>
                  <label for="frequencia">Frequência</label>
                  <select id="frequencia" required>
                    <option value="">Selecione</option>
                    <option value="1x/dia">1x/dia</option>
                    <option value="2x/dia">2x/dia</option>
                    <option value="3x/dia">3x/dia</option>
                  </select>
                </div>
                <div>
                  <label for="duracao">Duração (dias)</label>
                  <input id="duracao" type="number" min="1" step="1" required />
                </div>
                <div>
                  <label for="observacoes">Observações adicionais</label>
                  <textarea id="observacoes" placeholder="Instruções extras para o tutor"></textarea>
                </div>
                <button class="btn" type="submit">Gerar Receita Digital</button>
              </form>
            </article>
            <article class="prescription-card">
              <h3>Referências rápidas</h3>
              <div id="ativoResumo" class="muted">Selecione um ativo na biblioteca ou utilize o campo acima.</div>
              <div id="referenciasAtivo"></div>
            </article>
          </div>
        </section>

        <section id="tab-biblioteca" class="tab-panel" role="tabpanel" aria-labelledby="tabBtnBiblioteca">
          <div class="library-controls">
            <input id="librarySearch" type="search" placeholder="Busque por nome, classe terapêutica, indicação ou mecanismo" aria-label="Buscar ativo" />
            <select id="libraryFilter" aria-label="Filtrar por classe terapêutica">
              <option value="">Todas as classes</option>
            </select>
          </div>
          <div id="libraryList" class="library-list" aria-live="polite"></div>
        </section>

        <section id="tab-historico" class="tab-panel" role="tabpanel" aria-labelledby="tabBtnHistorico">
          <div id="historicoContainer"></div>
        </section>

        <section id="tab-config" class="tab-panel" role="tabpanel" aria-labelledby="tabBtnConfig">
          <div class="config-card">
            <div>
              <h3>Integrações futuras</h3>
              <p class="muted">Reserve este espaço para conectar com APIs, ERPs e farmacêuticas parceiras.</p>
            </div>
            <div>
              <h4>Notificações</h4>
              <p class="muted">Configurações de alerta serão adicionadas em uma próxima etapa.</p>
            </div>
            <div>
              <h4>Exportação</h4>
              <p class="muted">Suporte a PDF assinado digitalmente (ICP-Brasil) e integração com dispensação automática.</p>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div id="previewModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="previewTitle" tabindex="-1">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <h3 id="previewTitle">Pré-visualização da receita</h3>
          <p class="muted">Revise as informações antes de compartilhar com o tutor.</p>
        </div>
        <button id="closePreview" class="btn-outline btn" type="button">Fechar</button>
      </div>
      <div class="modal-body">
        <div id="previewContent" class="preview-receita"></div>
      </div>
      <div class="modal-footer">
        <button id="copyLinkBtn" class="btn-outline btn" type="button">Copiar Link Local</button>
        <button id="downloadBtn" class="btn" type="button">Baixar Arquivo (.html)</button>
      </div>
    </div>
  </div>

  <script>
    const Auth = (() => {
      const USERS_KEY = 'bf_users';
      const SESSION_KEY = 'bf_session';

      const loadUsers = () => {
        try {
          return JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
        } catch (err) {
          console.error('Erro ao ler usuários', err);
          return [];
        }
      };

      const saveUsers = (users) => localStorage.setItem(USERS_KEY, JSON.stringify(users));

      const validateEmail = (email) => /[^\s@]+@[^\s@]+\.[^\s@]+/.test(email);

      return {
        register({ nome, email, crmv, senha }) {
          if (!validateEmail(email)) {
            throw new Error('Informe um e-mail válido.');
          }
          if (!senha || senha.length < 6) {
            throw new Error('Senha deve ter pelo menos 6 caracteres.');
          }
          if (!crmv.trim()) {
            throw new Error('CRMV é obrigatório.');
          }
          const users = loadUsers();
          if (users.some((user) => user.email.toLowerCase() === email.toLowerCase())) {
            throw new Error('E-mail já cadastrado.');
          }
          const newUser = {
            id: Date.now(),
            nome,
            email,
            crmv,
            senhaHash: btoa(unescape(encodeURIComponent(senha)))
          };
          users.push(newUser);
          saveUsers(users);
          return newUser;
        },
        login(email, senha) {
          const users = loadUsers();
          const senhaHash = btoa(unescape(encodeURIComponent(senha)));
          const user = users.find((u) => u.email.toLowerCase() === email.toLowerCase() && u.senhaHash === senhaHash);
          if (!user) {
            throw new Error('Credenciais inválidas.');
          }
          localStorage.setItem(SESSION_KEY, JSON.stringify({ id: user.id, nome: user.nome, email: user.email, crmv: user.crmv }));
          return user;
        },
        logout() {
          localStorage.removeItem(SESSION_KEY);
        },
        currentSession() {
          try {
            const raw = localStorage.getItem(SESSION_KEY);
            return raw ? JSON.parse(raw) : null;
          } catch (err) {
            console.error('Erro ao ler sessão', err);
            return null;
          }
        }
      };
    })();

    const Store = (() => {
      const PRESCRIPTIONS_KEY = 'bf_prescriptions';

      const read = () => {
        try {
          return JSON.parse(localStorage.getItem(PRESCRIPTIONS_KEY) || '[]');
        } catch (err) {
          console.error('Erro ao carregar prescrições', err);
          return [];
        }
      };

      const write = (data) => localStorage.setItem(PRESCRIPTIONS_KEY, JSON.stringify(data));

      return {
        all() { return read(); },
        add(prescription) {
          const data = read();
          data.unshift(prescription);
          write(data);
          return data;
        }
      };
    })();

    const Library = (() => {
      const data = [
        {
          "id": "silimarina",
          "nome": "Silimarina",
          "classe": "Fitoterápico / Hepatoprotetor",
          "subclasse": "Flavonolignanas",
          "mecanismo": "Efeito antioxidante e estabilização de membrana hepatocitária",
          "indicacoes": ["Doenças hepáticas", "Hepatoproteção", "Intoxicações"],
          "especies": ["Cães", "Gatos"],
          "dosagem": "20–50 mg/kg",
          "forma": ["oral"],
          "observacoes": "Geralmente bem tolerado."
        },
        {
          "id": "itraconazol",
          "nome": "Itraconazol",
          "classe": "Antifúngico",
          "subclasse": "Triazólico",
          "mecanismo": "Inibição da síntese de ergosterol da membrana fúngica",
          "indicacoes": ["Dermatomicoses", "Onicomicoses", "Micoses sistêmicas (selecionadas)"],
          "especies": ["Cães", "Gatos"],
          "dosagem": "5–10 mg/kg",
          "forma": ["oral"],
          "observacoes": "Monitorar função hepática em tratamentos prolongados."
        },
        {
          "id": "pimobendan",
          "nome": "Pimobendan",
          "classe": "Cardiovascular",
          "subclasse": "Inodilatador",
          "mecanismo": "Sensibilização ao cálcio + inibição da fosfodiesterase III",
          "indicacoes": ["Insuficiência cardíaca", "DVI/DCM em cães"],
          "especies": ["Cães"],
          "dosagem": "0,2–0,6 mg/kg/dia (dividido 2x)",
          "forma": ["oral"],
          "observacoes": "Administrar em jejum para melhor absorção."
        },
        {
          "id": "cefalexina",
          "nome": "Cefalexina",
          "classe": "Antibiótico",
          "subclasse": "Cefalosporina de 1ª geração",
          "mecanismo": "Inibição da síntese da parede celular bacteriana",
          "indicacoes": ["Dermatites bacterianas", "Infecções de tecidos moles"],
          "especies": ["Cães", "Gatos"],
          "dosagem": "20–30 mg/kg a cada 12h",
          "forma": ["oral"],
          "observacoes": "Ajustar dose em insuficiência renal."
        },
        {
          "id": "enrofloxacino",
          "nome": "Enrofloxacino",
          "classe": "Antibiótico",
          "subclasse": "Fluoroquinolona",
          "mecanismo": "Inibição da DNA girase",
          "indicacoes": ["Infecções bacterianas sensíveis"],
          "especies": ["Cães", "Gatos (cautela)"],
          "dosagem": "5–10 mg/kg a cada 24h",
          "forma": ["oral", "injetável"],
          "observacoes": "Evitar em animais jovens em crescimento; risco ocular em gatos com doses altas."
        },
        {
          "id": "omeprazol",
          "nome": "Omeprazol",
          "classe": "Gastrointestinal",
          "subclasse": "IBP (Inibidor da Bomba de Prótons)",
          "mecanismo": "Inibição irreversível da H+/K+ ATPase",
          "indicacoes": ["Gastrite", "Úlcera gástrica", "Refluxo"],
          "especies": ["Cães", "Gatos"],
          "dosagem": "0,5–1 mg/kg a cada 24h",
          "forma": ["oral"],
          "observacoes": "Administrar antes das refeições."
        },
        {
          "id": "furosemida",
          "nome": "Furosemida",
          "classe": "Cardiovascular",
          "subclasse": "Diurético de alça",
          "mecanismo": "Inibição do co-transporte Na+/K+/2Cl- na alça de Henle",
          "indicacoes": ["Edema", "Insuficiência cardíaca congestiva"],
          "especies": ["Cães", "Gatos (cautela)"],
          "dosagem": "1–2 mg/kg a cada 8–12h",
          "forma": ["oral", "injetável"],
          "observacoes": "Monitorar eletrólitos e função renal."
        },
        {
          "id": "benazepril",
          "nome": "Benazepril",
          "classe": "Cardiovascular",
          "subclasse": "IECA",
          "mecanismo": "Inibição da enzima conversora de angiotensina",
          "indicacoes": ["Insuficiência cardíaca", "Proteinúria"],
          "especies": ["Cães", "Gatos"],
          "dosagem": "0,25–0,5 mg/kg a cada 24h",
          "forma": ["oral"],
          "observacoes": "Monitorar pressão e creatinina, especialmente com diuréticos."
        },
        {
          "id": "sildenafila",
          "nome": "Sildenafila",
          "classe": "Cardiovascular",
          "subclasse": "Inibidor de PDE5",
          "mecanismo": "Aumento de GMPc e vasodilatação pulmonar",
          "indicacoes": ["Hipertensão pulmonar"],
          "especies": ["Cães"],
          "dosagem": "1–3 mg/kg a cada 8–12h",
          "forma": ["oral"],
          "observacoes": "Avaliar interação com outros vasodilatadores."
        }
      ];

      const uniqueClasses = Array.from(new Set(data.map((item) => item.classe)));

      const findById = (id) => data.find((item) => item.id === id);

      const search = (term, classe) => {
        const q = term.trim().toLowerCase();
        return data.filter((item) => {
          const matchesClasse = !classe || item.classe === classe;
          if (!matchesClasse) return false;
          if (!q) return true;
          const haystack = [
            item.nome,
            item.classe,
            item.subclasse || '',
            item.mecanismo,
            ...(item.indicacoes || [])
          ].join(' ').toLowerCase();
          return haystack.includes(q);
        });
      };

      return {
        all() { return data.slice(); },
        search,
        findById,
        classes() { return uniqueClasses.slice(); }
      };
    })();
    const UI = (() => {
      const authView = document.getElementById('authView');
      const appView = document.getElementById('appView');
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const authLoginTab = document.getElementById('authLoginTab');
      const authRegisterTab = document.getElementById('authRegisterTab');
      const headerUser = document.getElementById('headerUser');
      const logoutBtn = document.getElementById('logoutBtn');
      const newPrescriptionBtn = document.getElementById('newPrescriptionBtn');
      const themeToggle = document.getElementById('themeToggle');
      const globalSearch = document.getElementById('globalSearch');
      const globalSearchBtn = document.getElementById('globalSearchBtn');

      const tabButtons = [
        document.getElementById('tabBtnPrescrever'),
        document.getElementById('tabBtnBiblioteca'),
        document.getElementById('tabBtnHistorico'),
        document.getElementById('tabBtnConfig')
      ];
      const tabPanels = [
        document.getElementById('tab-prescrever'),
        document.getElementById('tab-biblioteca'),
        document.getElementById('tab-historico'),
        document.getElementById('tab-config')
      ];

      const toastContainer = document.getElementById('toastContainer');

      const toggleForms = (target) => {
        const showingLogin = target === 'login';
        loginForm.classList.toggle('hidden', !showingLogin);
        registerForm.classList.toggle('hidden', showingLogin);
        authLoginTab.classList.toggle('active', showingLogin);
        authRegisterTab.classList.toggle('active', !showingLogin);
        authLoginTab.setAttribute('aria-selected', showingLogin);
        authRegisterTab.setAttribute('aria-selected', !showingLogin);
        (showingLogin ? loginForm : registerForm).querySelector('input')?.focus();
      };

      const showToast = (message, type = 'success') => {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('hidden');
          setTimeout(() => toast.remove(), 200);
        }, 3600);
      };

      const openTab = (index) => {
        tabButtons.forEach((btn, idx) => {
          const selected = idx === index;
          btn.setAttribute('aria-selected', selected);
          btn.classList.toggle('active', selected);
          tabPanels[idx].classList.toggle('active', selected);
        });
        if (index === 2) {
          Prescriptions.updateHistory();
        }
        if (index === 1) {
          LibraryView.focusSearch();
        }
      };

      const loadTheme = () => {
        const stored = localStorage.getItem('bf_theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const useDark = stored ? stored === 'dark' : prefersDark;
        document.body.classList.toggle('theme-dark', useDark);
        themeToggle.checked = useDark;
      };

      const setTheme = (isDark) => {
        document.body.classList.toggle('theme-dark', isDark);
        localStorage.setItem('bf_theme', isDark ? 'dark' : 'light');
      };

      const enterApp = (user) => {
        authView.classList.add('hidden');
        appView.classList.remove('hidden');
        headerUser.textContent = `Logado como: Dr(a). ${user.nome} — CRMV: ${user.crmv}`;
        Prescriptions.setPrescriber(user);
        Prescriptions.populateDatalist();
        Prescriptions.updateHistory();
        LibraryView.render();
      };

      const exitApp = () => {
        Auth.logout();
        appView.classList.add('hidden');
        authView.classList.remove('hidden');
        toggleForms('login');
        loginForm.reset();
        registerForm.reset();
      };

      authLoginTab.addEventListener('click', () => toggleForms('login'));
      authRegisterTab.addEventListener('click', () => toggleForms('register'));

      loginForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const formData = new FormData(loginForm);
        try {
          const user = Auth.login(formData.get('email'), formData.get('senha'));
          showToast(`Bem-vindo(a) de volta, Dr(a). ${user.nome}!`);
          enterApp(user);
          loginForm.reset();
        } catch (err) {
          showToast(err.message, 'error');
        }
      });

      registerForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const formData = new FormData(registerForm);
        try {
          const user = Auth.register({
            nome: formData.get('nome').trim(),
            email: formData.get('email').trim(),
            crmv: formData.get('crmv').trim(),
            senha: formData.get('senha')
          });
          showToast('Cadastro realizado com sucesso! Faça login com suas credenciais.');
          toggleForms('login');
          loginForm.email.value = user.email;
        } catch (err) {
          showToast(err.message, 'error');
        }
      });

      logoutBtn.addEventListener('click', () => {
        exitApp();
        showToast('Sessão encerrada. Até breve!', 'success');
      });

      tabButtons.forEach((btn, idx) => {
        btn.addEventListener('click', () => openTab(idx));
      });

      newPrescriptionBtn.addEventListener('click', () => {
        openTab(0);
        Prescriptions.resetForm();
      });

      themeToggle.addEventListener('change', (event) => setTheme(event.target.checked));

      globalSearchBtn.addEventListener('click', () => {
        LibraryView.setQuery(globalSearch.value);
        openTab(1);
      });

      globalSearch.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          LibraryView.setQuery(globalSearch.value);
          openTab(1);
        }
      });

      loadTheme();

      const initialize = () => {
        const session = Auth.currentSession();
        if (session) {
          enterApp(session);
        }
      };

      return { showToast, openTab, initialize };
    })();

    const LibraryView = (() => {
      const listEl = document.getElementById('libraryList');
      const searchInput = document.getElementById('librarySearch');
      const filterSelect = document.getElementById('libraryFilter');
      let currentQuery = '';
      let currentFilter = '';

      const renderList = () => {
        const results = Library.search(currentQuery, currentFilter);
        if (!results.length) {
          listEl.innerHTML = '<div class="empty-state">Nenhum ativo encontrado para os filtros selecionados.</div>';
          return;
        }
        listEl.innerHTML = results.map((item) => {
          const indicacoes = (item.indicacoes || []).map((i) => `<li>${i}</li>`).join('');
          const especies = (item.especies || []).map((e) => `<span>${e}</span>`).join('');
          const formas = (item.forma || []).map((f) => `<span>${f}</span>`).join('');
          return `
            <article class="library-card">
              <div class="badge">${item.classe}</div>
              <h3>${item.nome}</h3>
              <p class="muted">${item.subclasse || ''}</p>
              <p><strong>Mecanismo:</strong> ${item.mecanismo}</p>
              <div>
                <strong>Indicações principais</strong>
                <ul>${indicacoes}</ul>
              </div>
              <div class="pill-list" aria-label="Espécies indicadas">${especies}</div>
              <p><strong>Dosagem recomendada:</strong> ${item.dosagem || 'Consultar literatura'}</p>
              <div class="pill-list" aria-label="Formas farmacêuticas">${formas}</div>
              <p class="muted">${item.observacoes || ''}</p>
              <button class="btn" type="button" data-ativo="${item.id}">Usar na prescrição</button>
            </article>
          `;
        }).join('');
        listEl.querySelectorAll('[data-ativo]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const ativo = Library.findById(btn.dataset.ativo);
            if (ativo) {
              Prescriptions.setActiveFromLibrary(ativo);
              UI.showToast(`${ativo.nome} adicionado ao formulário de prescrição.`);
              UI.openTab(0);
            }
          });
        });
      };

      searchInput.addEventListener('input', (event) => {
        currentQuery = event.target.value;
        renderList();
      });

      filterSelect.addEventListener('change', (event) => {
        currentFilter = event.target.value;
        renderList();
      });

      const renderFilterOptions = () => {
        const options = Library.classes();
        filterSelect.innerHTML = '<option value="">Todas as classes</option>' + options.map((classe) => `<option value="${classe}">${classe}</option>`).join('');
      };

      const setQuery = (query) => {
        currentQuery = query;
        searchInput.value = query;
        renderList();
      };

      const focusSearch = () => searchInput.focus();

      const render = () => {
        renderFilterOptions();
        renderList();
      };

      return { render, setQuery, focusSearch };
    })();
    const Prescriptions = (() => {
      const form = document.getElementById('prescriptionForm');
      const pesoInput = document.getElementById('peso');
      const doseRange = document.getElementById('doseRange');
      const doseMgKgInput = document.getElementById('doseMgKg');
      const doseResumo = document.getElementById('doseResumo');
      const doseHint = document.getElementById('doseHint');
      const doseRangeWrapper = document.getElementById('doseRangeWrapper');
      const ativoInput = document.getElementById('ativoNome');
      const datalist = document.getElementById('ativosDatalist');
      const resumoAtivo = document.getElementById('ativoResumo');
      const referenciasAtivo = document.getElementById('referenciasAtivo');
      const historicoContainer = document.getElementById('historicoContainer');

      const previewModal = document.getElementById('previewModal');
      const previewContent = document.getElementById('previewContent');
      const closePreviewBtn = document.getElementById('closePreview');
      const downloadBtn = document.getElementById('downloadBtn');
      const copyLinkBtn = document.getElementById('copyLinkBtn');

      let prescriber = null;
      let currentAtivo = null;
      let currentRange = null;
      let lastPreviewData = null;

      const parseRange = (text) => {
        if (!text) return null;
        const normalized = text.replace(',', '.');
        const regex = /(\d+(?:\.\d+)?)\s*[\u2013\-]\s*(\d+(?:\.\d+)?)/;
        const match = normalized.match(regex);
        if (match) {
          const min = parseFloat(match[1]);
          const max = parseFloat(match[2]);
          if (!Number.isNaN(min) && !Number.isNaN(max)) {
            return { min, max };
          }
        }
        return null;
      };

      const updateDoseResumo = () => {
        const peso = parseFloat(pesoInput.value);
        const mgKg = parseFloat(doseMgKgInput.value);
        if (!peso || peso <= 0 || !mgKg || mgKg <= 0) {
          doseResumo.textContent = 'Informe peso e mg/kg para calcular a dose.';
          return null;
        }
        const mgDose = peso * mgKg;
        doseResumo.innerHTML = `Dose por administração: <strong>${mgDose.toFixed(2)} mg</strong><br>` +
          `Cálculo baseado em ${mgKg.toFixed(2)} mg/kg para ${peso.toFixed(2)} kg.`;
        return mgDose;
      };

      const updateAtivoResumo = () => {
        if (!currentAtivo) {
          resumoAtivo.textContent = 'Selecione um ativo na biblioteca ou utilize o campo acima.';
          referenciasAtivo.innerHTML = '';
          return;
        }
        resumoAtivo.innerHTML = `<strong>${currentAtivo.nome}</strong> · ${currentAtivo.classe}${currentAtivo.subclasse ? ` — ${currentAtivo.subclasse}` : ''}`;
        referenciasAtivo.innerHTML = `
          <p><strong>Indicações:</strong> ${(currentAtivo.indicacoes || []).join(', ')}</p>
          <p><strong>Espécies:</strong> ${(currentAtivo.especies || []).join(', ')}</p>
          <p><strong>Dosagem referência:</strong> ${currentAtivo.dosagem || 'Consultar literatura'}</p>
          <p class="muted"><strong>Mecanismo:</strong> ${currentAtivo.mecanismo}</p>
          <p class="muted">${currentAtivo.observacoes || ''}</p>
        `;
      };

      const applyRange = (range) => {
        currentRange = range;
        if (range) {
          doseRangeWrapper.classList.remove('hidden');
          doseRangeWrapper.classList.remove('no-range');
          doseRange.min = range.min;
          doseRange.max = range.max;
          const defaultValue = ((range.min + range.max) / 2).toFixed(2);
          doseRange.value = defaultValue;
          doseMgKgInput.value = defaultValue;
          doseHint.textContent = `Intervalo recomendado: ${range.min} – ${range.max} mg/kg.`;
        } else {
          doseHint.textContent = 'Informe manualmente a posologia desejada.';
          doseRangeWrapper.classList.add('no-range');
        }
        updateDoseResumo();
      };

      const setActiveFromLibrary = (ativo) => {
        currentAtivo = ativo;
        ativoInput.value = ativo.nome;
        applyRange(parseRange(ativo.dosagem));
        updateAtivoResumo();
      };

      const populateDatalist = () => {
        datalist.innerHTML = Library.all().map((item) => `<option value="${item.nome}"></option>`).join('');
      };

      const detectAtivoByName = (nome) => {
        if (!nome) return null;
        const lower = nome.trim().toLowerCase();
        return Library.all().find((item) => item.nome.toLowerCase() === lower);
      };

      const resetForm = () => {
        form.reset();
        currentAtivo = null;
        currentRange = null;
        doseHint.textContent = 'Selecione um ativo para sugestões de dose.';
        resumoAtivo.textContent = 'Selecione um ativo na biblioteca ou utilize o campo acima.';
        referenciasAtivo.innerHTML = '';
        doseResumo.textContent = 'Informe peso e mg/kg para calcular a dose.';
        doseRangeWrapper.classList.add('no-range');
      };

      const toggleModal = (open) => {
        previewModal.classList.toggle('open', open);
        if (open) {
          previewModal.focus();
        }
      };

      const generateHash = (payload) => {
        let hash = 0;
        const text = `${Date.now()}-${payload}`;
        for (let i = 0; i < text.length; i += 1) {
          hash = (hash << 5) - hash + text.charCodeAt(i);
          hash |= 0;
        }
        return `BF-${Math.abs(hash).toString(16).toUpperCase()}`;
      };

      const buildPreview = (data) => {
        const linhas = data.medicamentos.map((item, index) => `
          <tr>
            <td>${index + 1}</td>
            <td>${item.nome}</td>
            <td>${item.doseMg.toFixed(2)} mg (${item.mgKg.toFixed(2)} mg/kg)</td>
            <td>${item.frequencia} · ${item.duracao} dias</td>
          </tr>
        `).join('');

        const nomePaciente = data.paciente || data.animal.nome;

        return `
          <div>
            <strong>Prescritor:</strong> Dr(a). ${data.prescritor.nome} — CRMV ${data.prescritor.crmv}
          </div>
          <div>
            <strong>Tutor:</strong> ${data.tutor || '—'} · <strong>Paciente:</strong> ${nomePaciente} (${data.animal.especie})
          </div>
          <div>
            <strong>Peso:</strong> ${data.animal.peso.toFixed(2)} kg ${data.animal.idade ? `· <strong>Idade:</strong> ${data.animal.idade}` : ''}
          </div>
          <div>
            <strong>Diagnóstico:</strong> ${data.diagnostico || '—'}
          </div>
          <table class="preview-table" aria-label="Resumo da prescrição">
            <thead>
              <tr><th>#</th><th>Medicamento</th><th>Dosagem</th><th>Posologia</th></tr>
            </thead>
            <tbody>${linhas}</tbody>
          </table>
          <div>
            <strong>Observações:</strong>
            <p>${data.observacoes || 'Sem observações adicionais.'}</p>
          </div>
          <div>
            <strong>Hash de validação:</strong> ${data.hash}
          </div>
        `;
      };

      const buildPrescriptionHtml = (data) => {
        const linhas = data.medicamentos.map((item, index) => `
          <tr>
            <td>${index + 1}</td>
            <td>${item.nome}</td>
            <td>${item.doseMg.toFixed(2)} mg (${item.mgKg.toFixed(2)} mg/kg)</td>
            <td>${item.frequencia} · ${item.duracao} dias</td>
          </tr>
        `).join('');

        return `<!doctype html><html lang="pt-BR"><head><meta charset="utf-8" />
          <title>Receita digital — ${data.animal.nome}</title>
          <style>
            body{font-family:'Segoe UI',Arial,sans-serif;background:#f4f7f9;margin:0;padding:32px;color:#263238;}
            .sheet{max-width:720px;margin:0 auto;background:#fff;border-radius:20px;padding:36px;box-shadow:0 18px 46px rgba(38,50,56,0.16);border:1px solid rgba(38,50,56,0.08);}
            h1{margin:0 0 12px;font-size:26px;color:#2E7D32;text-transform:uppercase;letter-spacing:0.05em;}
            .meta{display:grid;gap:10px;margin-bottom:24px;font-size:15px;}
            table{width:100%;border-collapse:collapse;margin-bottom:24px;}
            th,td{padding:12px 10px;border-bottom:1px solid rgba(38,50,56,0.12);text-align:left;font-size:14px;}
            tbody tr:last-child td{border-bottom:none;}
            .observacoes{padding:16px;border-radius:14px;background:rgba(46,125,50,0.08);border:1px dashed rgba(46,125,50,0.25);font-size:14px;}
            .hash{margin-top:18px;font-size:13px;color:#60707b;}
            .ads{margin-top:32px;padding:20px;border-radius:18px;background:linear-gradient(120deg,rgba(46,125,50,0.1),rgba(46,125,50,0.02));border:1px solid rgba(46,125,50,0.12);}
            .ads h2{margin:0 0 12px;font-size:18px;color:#2E7D32;}
            .ads-grid{display:grid;gap:12px;grid-template-columns:1fr;}
            .ads-card{background:#fff;border-radius:16px;padding:16px;border:1px solid rgba(38,50,56,0.08);display:flex;flex-direction:column;gap:6px;}
            .ads-card button{align-self:flex-start;padding:8px 14px;border-radius:999px;border:1px solid #2E7D32;background:transparent;color:#2E7D32;font-weight:600;cursor:pointer;}
            @media(min-width:640px){.ads-grid{grid-template-columns:repeat(3,minmax(0,1fr));}}
          </style>
        </head><body>
          <div class="sheet">
            <h1>Receita Digital Veterinária</h1>
            <div class="meta">
              <div><strong>Prescritor:</strong> Dr(a). ${data.prescritor.nome} — CRMV ${data.prescritor.crmv}</div>
              <div><strong>Tutor:</strong> ${data.tutor || '—'}</div>
              <div><strong>Paciente:</strong> ${(data.paciente || data.animal.nome)} (${data.animal.especie}) · ${data.animal.peso.toFixed(2)} kg ${data.animal.idade ? `· ${data.animal.idade}` : ''}</div>
              <div><strong>Diagnóstico:</strong> ${data.diagnostico || '—'}</div>
              <div><strong>Data:</strong> ${new Date(data.criadoEm).toLocaleString('pt-BR')}</div>
            </div>
            <table>
              <thead><tr><th>#</th><th>Medicamento</th><th>Dosagem</th><th>Posologia</th></tr></thead>
              <tbody>${linhas}</tbody>
            </table>
            <div class="observacoes">
              <strong>Observações para o tutor</strong>
              <p>${data.observacoes || '—'}</p>
            </div>
            <div class="hash">Identificador da prescrição: ${data.hash}</div>
            <div class="ads">
              <h2>💊 Encontre os melhores preços para estes medicamentos</h2>
              <p>Farmácias conveniadas anunciam aqui.</p>
              <div class="ads-grid">
                <div class="ads-card"><strong>PharmaVet Plus</strong><span>WhatsApp: (11) 99999-0000</span><button>Acessar</button></div>
                <div class="ads-card"><strong>Clínica Farma Animal</strong><span>Telefone: (21) 3333-4444</span><button>Acessar</button></div>
                <div class="ads-card"><strong>PetSaúde Express</strong><span>WhatsApp: (31) 98888-5555</span><button>Acessar</button></div>
              </div>
            </div>
          </div>
        </body></html>`;
      };

      const openPreview = (data) => {
        lastPreviewData = data;
        previewContent.innerHTML = buildPreview(data);
        toggleModal(true);
      };

      const closePreview = () => {
        toggleModal(false);
      };

      const handleDownload = () => {
        if (!lastPreviewData) return;
        const html = buildPrescriptionHtml(lastPreviewData);
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        const nomeAnimal = lastPreviewData.animal.nome.replace(/\s+/g, '-').toLowerCase();
        link.download = `receita-${nomeAnimal}.html`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      };

      const handleCopyLink = async () => {
        if (!lastPreviewData) return;
        const html = buildPrescriptionHtml(lastPreviewData);
        const encoded = encodeURIComponent(html);
        const dataUrl = `data:text/html;charset=utf-8,${encoded}`;
        try {
          await navigator.clipboard.writeText(dataUrl);
          UI.showToast('Link local copiado para a área de transferência.');
        } catch (err) {
          UI.showToast('Não foi possível copiar automaticamente. Copie manualmente após abrir o arquivo.', 'error');
          window.open(dataUrl, '_blank');
        }
      };

      const renderHistorico = (prescricoes) => {
        if (!prescricoes.length) {
          historicoContainer.innerHTML = '<div class="empty-state">Nenhuma prescrição gerada ainda. Utilize o botão "Gerar Receita Digital" para começar.</div>';
          return;
        }
        const rows = prescricoes.map((item, index) => `
          <tr>
            <td>${new Date(item.criadoEm).toLocaleString('pt-BR')}</td>
            <td>${item.animal.nome}</td>
            <td>${item.animal.especie}</td>
            <td>${item.medicamentos[0]?.nome || '—'}</td>
            <td>${item.medicamentos[0]?.doseMg.toFixed(2) || '—'} mg</td>
            <td>${item.medicamentos[0]?.duracao || '—'} dias</td>
            <td>
              <div class="actions-row">
                <button class="btn-outline btn" data-action="ver" data-index="${index}" type="button">Ver</button>
                <button class="btn" data-action="refazer" data-index="${index}" type="button">Prescrever novamente</button>
              </div>
            </td>
          </tr>
        `).join('');

        historicoContainer.innerHTML = `
          <table class="history-table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Animal</th>
                <th>Espécie</th>
                <th>Ativo</th>
                <th>Dose</th>
                <th>Duração</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;

        historicoContainer.querySelectorAll('button[data-action="ver"]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const data = Store.all()[parseInt(btn.dataset.index, 10)];
            if (data) {
              openPreview(data);
            }
          });
        });

        historicoContainer.querySelectorAll('button[data-action="refazer"]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const data = Store.all()[parseInt(btn.dataset.index, 10)];
            if (data) {
              refillForm(data);
              UI.openTab(0);
              UI.showToast('Formulário preenchido com os dados da prescrição selecionada.');
            }
          });
        });
      };

      const refillForm = (data) => {
        form.reset();
        document.getElementById('animalNome').value = data.animal.nome;
        document.getElementById('especie').value = data.animal.especie;
        document.getElementById('peso').value = data.animal.peso;
        document.getElementById('idade').value = data.animal.idade || '';
        document.getElementById('diagnostico').value = data.diagnostico || '';
        document.getElementById('forma').value = data.medicamentos[0]?.forma || '';
        document.getElementById('frequencia').value = data.medicamentos[0]?.frequencia || '';
        document.getElementById('duracao').value = data.medicamentos[0]?.duracao || '';
        document.getElementById('observacoes').value = data.observacoes || '';
        const ativo = detectAtivoByName(data.medicamentos[0]?.nome || '');
        if (ativo) {
          setActiveFromLibrary(ativo);
        } else {
          ativoInput.value = data.medicamentos[0]?.nome || '';
          doseMgKgInput.value = data.medicamentos[0]?.mgKg || '';
          updateDoseResumo();
        }
        pesoInput.dispatchEvent(new Event('input'));
      };

      const createPrescriptionPayload = () => {
        const animal = document.getElementById('animalNome').value.trim();
        const especie = document.getElementById('especie').value;
        const peso = parseFloat(pesoInput.value);
        const idade = document.getElementById('idade').value.trim();
        const diagnostico = document.getElementById('diagnostico').value.trim();
        const ativoNome = ativoInput.value.trim();
        const forma = document.getElementById('forma').value.trim();
        const mgKg = parseFloat(doseMgKgInput.value);
        const mgDose = updateDoseResumo();
        const frequencia = document.getElementById('frequencia').value;
        const duracao = document.getElementById('duracao').value;
        const observacoes = document.getElementById('observacoes').value.trim();

        if (!animal || !especie || !peso || !ativoNome || !mgKg || !mgDose || !frequencia || !duracao) {
          throw new Error('Preencha todos os campos obrigatórios do formulário.');
        }

        const tutor = document.getElementById('tutorNome')?.value || '';
        const paciente = document.getElementById('pacienteNome')?.value || animal;

        const medicamento = {
          nome: ativoNome,
          forma,
          mgKg,
          doseMg: mgDose,
          frequencia,
          duracao,
          observacoes
        };

        const hash = generateHash(JSON.stringify({ medicamento, animal, tutor, paciente }));

        return {
          prescritor: prescriber,
          tutor,
          paciente,
          animal: { nome: animal, especie, peso, idade },
          diagnostico,
          medicamentos: [medicamento],
          observacoes,
          hash,
          criadoEm: new Date().toISOString()
        };
      };

      // Futuro: integração com farmácias parceiras (Firebase/Apps Script)
      // function sendToPartnerPharmacies(prescription) {
      //   return fetch('https://api.biovetfarma.example/prescriptions', {
      //     method: 'POST',
      //     body: JSON.stringify(prescription),
      //     headers: { 'Content-Type': 'application/json' }
      //   });
      // }

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        try {
          const payload = createPrescriptionPayload();
          Store.add(payload);
          openPreview(payload);
          UI.showToast('Pré-visualização gerada! Revise antes de baixar ou compartilhar.');
          resetForm();
          renderHistorico(Store.all());
          LibraryView.render();
        } catch (err) {
          UI.showToast(err.message, 'error');
        }
      });

      pesoInput.addEventListener('input', updateDoseResumo);
      doseMgKgInput.addEventListener('input', () => {
        if (currentRange) {
          const value = parseFloat(doseMgKgInput.value);
          if (value >= currentRange.min && value <= currentRange.max) {
            doseRange.value = value;
          }
        }
        updateDoseResumo();
      });

      doseRange.addEventListener('input', (event) => {
        doseMgKgInput.value = parseFloat(event.target.value).toFixed(2);
        updateDoseResumo();
      });

      ativoInput.addEventListener('change', () => {
        const ativo = detectAtivoByName(ativoInput.value);
        if (ativo) {
          setActiveFromLibrary(ativo);
        } else {
          currentAtivo = null;
          currentRange = null;
          doseHint.textContent = 'Informe manualmente a posologia desejada.';
          referenciasAtivo.innerHTML = '';
          resumoAtivo.textContent = ativoInput.value ? `Ativo personalizado: ${ativoInput.value}` : 'Selecione um ativo na biblioteca ou utilize o campo acima.';
        }
      });

      closePreviewBtn.addEventListener('click', closePreview);
      downloadBtn.addEventListener('click', handleDownload);
      copyLinkBtn.addEventListener('click', handleCopyLink);
      previewModal.addEventListener('click', (event) => {
        if (event.target === previewModal) {
          closePreview();
        }
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closePreview();
        }
      });

      const setPrescriber = (user) => {
        prescriber = user;
      };

      const updateHistory = () => {
        const data = Store.all();
        renderHistorico(data);
      };

      return {
        setActiveFromLibrary,
        populateDatalist,
        setPrescriber,
        updateHistory,
        resetForm
      };
    })();

    UI.initialize();
  </script>
</body>
</html>
